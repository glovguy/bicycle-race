<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
</head>
<body>

<canvas id="draw" width="1265" height="492"></canvas>
<p></p>
<button id="playPause" onclick="playpause();">Pause</button>
<!-- <img id="blue-warrior-right" src="BlueSkullsWarrior.png" style="display: none;">
<img id="blue-warrior-left" src="BlueSkullsWarriorLeft.png" style="display: none;">
<img id="gold-queen-right" src="goldQueenRight.png" style="display: none;">
<img id="gold-queen-left" src="goldQueenLeft.png" style="display: none;"> -->

<h3>Blue: <span id="blueScore">0</span></h3>
<h3>Gold: <span id="goldScore">0</span></h3>
<textarea id="net-json" style="width:100%; height:200px; display:none;"></textarea>

<script type="text/javascript" src="https://cs.stanford.edu/people/karpathy/convnetjs/build/convnet-min.js"></script>
<script type="text/javascript" src="https://cs.stanford.edu/people/karpathy/convnetjs/build/deepqlearn.js"></script>
<script type="text/javascript" src="https://cs.stanford.edu/people/karpathy/convnetjs/build/util.js"></script>

<script type="text/javascript" src="utilities.js"></script>
<script type="text/javascript" src="physics.js"></script>
<script type="text/javascript" src="brain.js"></script>
<script type="text/javascript">
  const blueScoreDisplay = document.querySelector('#blueScore');
  const goldScoreDisplay = document.querySelector('#goldScore');
  const playPauseButton = document.querySelector('#playPause');

  const canvas = document.querySelector('#draw');
  const ctx = canvas.getContext('2d');

  let play = true;
  let score = { blue: 0, gold: 0 };
  let keysPressed = {};

  function actionInput(e) {
    if (e.keyCode == 32 && !keysPressed[32]) { this.jump(); }
    if (e.keyCode == 37) { protagonist.walkingDirection = -1; }
    if (e.keyCode == 39) { protagonist.walkingDirection = 1; }
  }

  function actionStop(e) {
    if (e.keyCode == 32) {
      keysPressed[32] = false;
      protagonist.kineticState.jumping = false;
    }
    if (e.keyCode == 37 && protagonist.walkingDirection == -1) { protagonist.walkingDirection = 0; }
    if (e.keyCode == 39 && protagonist.walkingDirection == 1) { protagonist.walkingDirection = 0; }
  }

  function jump() {
    keysPressed[32] = true;
    protagonist.kineticState.jumping = true;
    protagonist.kineticState.freefall = true;
  }

  function playpause() {
    if (play === false) {
      cycleOfLife();
      play = true;
      playPauseButton.innerHTML = 'Pause';
    } else {
      window.cancelAnimationFrame(requestId);
      requestId = undefined;
      play = false;
      playPauseButton.innerHTML = 'Play';
    }
  }

  function snapMoment(subject, other) {
    return [
      subject.pos.x,
      subject.pos.y,
      subject.vel.x,
      subject.vel.y,
      other.pos.x,
      other.pos.y,
      other.vel.x,
      other.vel.y,
      subject.kineticState.freefall,
      other.pos.x - subject.pos.x,
      other.pos.y - subject.pos.y,
    ];

  }

  function actionSnapshot(subject) {
    //keysPressed[32]
    return {
      walkingDirection: subject.walkingDirection,
      jumping: subject.jumping
    };
  }

  let brainDebounceCycles = 12;
  let currentCycle = 0;

  function cycleOfLife() {
    // handleJousts(allObjs);
    const collisions = findAllCollisions(allObjs);
    allObjs.forEach((obj) => {
      physicsCycle(obj, collisions[Object.id(obj)]);
    });
    if (currentCycle == brainDebounceCycles) {
      currentCycle = 0;
      botBrainCycle();
    }
    currentCycle += 1;

    requestId = requestAnimFrame(cycleOfLife);

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeRect(0, 0, canvas.width, canvas.height);
    allObjs.forEach(drawObject);
    allObjs.forEach((obj) => {
      if (obj.display.decay !== undefined) {
        obj.display.decay -= 1 * timeDel;
      }
    });
    allObjs = allObjs.filter((obj) => obj.display.decay == undefined || obj.display.decay > 0 );
  }

  function debrisFromUser($event) {
    spawnDebrisAt($event.offsetX, $event.offsetY, 10*(Math.random()-0.5), 10*(Math.random()-0.5));
  }

  window.addEventListener('keydown', actionInput);
  window.addEventListener('keyup', actionStop);
  canvas.addEventListener('click', debrisFromUser);

  cycleOfLife();
  if (agents.length > 1) {
    window.setTimeout(() => {
      respawn(bot);
    }, 1000*60);
  }

</script>

</body>
</html>
